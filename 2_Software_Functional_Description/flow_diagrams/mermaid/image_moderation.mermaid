sequenceDiagram
    participant User as Utilisateur
    participant SenderApp as Application (Expéditeur)
    participant API as API Gateway
    participant MS as media-service
    participant MOD as moderation-service
    
    User->>SenderApp: Sélectionne un média à envoyer
    
    SenderApp->>SenderApp: Génère un hash perceptuel (LSH) du média
    Note over SenderApp: Le hash perceptuel est calculé<br/>sur l'image en clair côté client
    
    SenderApp->>API: POST /api/v1/moderation/hash-check (hash perceptuel)
    API->>MOD: Transmission du hash pour vérification
    
    MOD->>MOD: Compare avec la base de référence de hashs interdits
    
    alt Hash similaire à du contenu interdit
        MOD-->>API: Média potentiellement inapproprié
        API-->>SenderApp: Alerte de contenu potentiellement inapproprié
        SenderApp-->>User: Notification de rejet ou avertissement
        
        alt Utilisateur conteste la décision
            User->>SenderApp: Conteste la modération
            SenderApp->>API: POST /api/v1/moderation/appeal 
            API->>MOD: Transmission de la contestation
            MOD->>MOD: Enregistrement pour examen ultérieur
            MOD-->>API: Confirmation de l'appel
            API-->>SenderApp: Notification de l'appel enregistré
        end
        
    else Hash acceptable
        MOD-->>API: Média acceptable
        API-->>SenderApp: Autorisation d'envoi
        
        Note over SenderApp: Processus d'envoi normal
        SenderApp->>SenderApp: Génère clé AES aléatoire pour le média
        SenderApp->>SenderApp: Chiffre le média avec la clé AES
        SenderApp->>API: POST /api/v1/media/upload (média chiffré)
        API->>MS: Transmission du média chiffré
        MS->>MS: Stockage du média chiffré
        MS-->>API: Retourne l'ID du média
        API-->>SenderApp: Transmission de l'ID média
    end
    
    Note over SenderApp,MOD: Le LSH permet de détecter du contenu inapproprié<br/>sans compromettre le chiffrement E2E,<br/>car seul un hash perceptuel est partagé, pas le média