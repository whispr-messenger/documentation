sequenceDiagram
    participant User as Créateur du Groupe
    participant MobileApp as Application Mobile
    participant API as API Gateway
    participant DS as delivery-service
    participant US as user-service
    participant IS as identity-service
    participant MS as media-service
    participant Members as Membres du Groupe

    User->>MobileApp: Demande de création d'un groupe
    MobileApp->>MobileApp: Interface de création (nom, photo, membres)
    User->>MobileApp: Sélectionne les contacts à ajouter
    User->>MobileApp: Configure nom et photo du groupe (optionnel)
    User->>MobileApp: Confirme la création
    
    Note over MobileApp: Création des clés de groupe Signal
    MobileApp->>MobileApp: Génère l'identifiant de groupe
    MobileApp->>MobileApp: Génère la clé de groupe Signal
    
    alt Photo de groupe fournie
        MobileApp->>MobileApp: Chiffre la photo avec la clé de groupe
        MobileApp->>API: POST /api/v1/media/upload (photo chiffrée)
        API->>MS: Transmission de la photo chiffrée
        MS->>MS: Stockage de la photo chiffrée
        MS-->>API: Retourne l'ID du média
        API-->>MobileApp: Transmission de l'ID média
    end
    
    MobileApp->>API: POST /api/v1/groups (metadata chiffrée, IDs membres)
    API->>DS: Transmission de la requête de création
    
    DS->>US: Vérification des droits d'accès aux membres
    US-->>DS: Confirmation des droits
    
    DS->>DS: Création de l'entrée de groupe dans la base
    
    loop Pour chaque membre du groupe
        DS->>IS: Récupération des preKeys des membres
        IS-->>DS: Liste des preKeys disponibles
        
        DS->>DS: Stockage des associations membres-groupe
    end
    
    DS-->>API: Confirmation de création + ID du groupe
    API-->>MobileApp: Transmission de la confirmation
    
    Note over MobileApp: Distribution des clés aux membres
    loop Pour chaque membre du groupe
        MobileApp->>MobileApp: Chiffre la clé de groupe pour chaque membre avec leur clé publique
        MobileApp->>API: POST /api/v1/messages (clé de groupe chiffrée)
        API->>DS: Transmission du message chiffré
        DS->>DS: Stockage du message chiffré pour distribution
        DS-->>Members: Notification de nouveau groupe (via push)
    end
    
    MobileApp-->>User: Affichage du groupe créé
    
    Members->>Members: Réception de la notification
    Members->>Members: Déchiffrement de la clé de groupe avec clé privée
    Members->>Members: Accès aux messages et médias du groupe avec la clé déchiffrée

    Note over MobileApp,Members: La communication au sein du groupe utilise<br/>le chiffrement de bout en bout avec<br/>la clé de groupe, suivant le protocole Signal
    